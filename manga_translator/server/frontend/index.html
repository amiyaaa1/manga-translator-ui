<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manga Translator Web Console</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --accent: #38bdf8;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2937;
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", "Microsoft YaHei", system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }

    a { color: var(--accent); }

    header {
      background: linear-gradient(90deg, #111827 0%, #0b1222 100%);
      padding: 18px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid #1f2937;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #0b1628;
      color: var(--muted);
      font-size: 12px;
    }

    .spacer { flex: 1; }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      color: #0b1222;
      background: var(--accent);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn:active { transform: translateY(1px); }
    .btn.secondary {
      background: #1f2937;
      color: var(--text);
      border: 1px solid #243045;
    }

    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
      padding: 18px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid #1f2937;
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .panel h3 {
      margin: 0 0 12px;
      font-size: 15px;
      letter-spacing: 0.4px;
      color: #cbd5e1;
    }

    .upload-area {
      border: 1px dashed #2b3a52;
      border-radius: 14px;
      background: #0d1526;
      padding: 14px;
      text-align: center;
      color: var(--muted);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .upload-area:hover { border-color: var(--accent); background: #0f1b30; }

    .file-list {
      margin: 12px 0 0;
      padding: 0;
      list-style: none;
      max-height: 320px;
      overflow: auto;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      margin-bottom: 8px;
      background: var(--card);
      border-radius: 10px;
      border: 1px solid #1f2937;
    }

    .file-name { flex: 1; font-size: 13px; color: #e5e7eb; }
    .file-status { font-size: 12px; color: var(--muted); }

    .tab-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #111827;
      color: var(--muted);
      cursor: pointer;
      font-weight: 600;
    }

    .tab-btn.active {
      background: var(--accent);
      color: #0b1222;
      border-color: transparent;
    }

    .tabs-content { background: var(--panel); }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--card);
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 12px;
    }

    .card h4 {
      margin: 0 0 8px;
      font-size: 14px;
      color: #d1d5db;
      letter-spacing: 0.4px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .form-row label { font-size: 13px; color: #cbd5e1; }
    .form-row small { color: var(--muted); font-size: 12px; }

    input, select, textarea {
      width: 100%;
      background: #0f172a;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 10px;
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    input:focus, select:focus, textarea:focus { border-color: var(--accent); }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: #0f172a;
      border-radius: 10px;
      border: 1px solid #1f2937;
    }

    .settings-actions { display: flex; gap: 10px; margin-top: 4px; }

    .log-box {
      background: #0d1526;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px;
      font-family: "JetBrains Mono", "Fira Code", monospace;
      font-size: 12px;
      height: 320px;
      overflow: auto;
      white-space: pre-line;
      color: #cbd5e1;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .thumb {
      background: #0d1526;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 8px;
      text-align: center;
    }

    .thumb img {
      max-width: 100%;
      border-radius: 8px;
      display: block;
      margin: 0 auto 8px;
    }

    .hint { color: var(--muted); font-size: 13px; }

    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .pill { background: #0d1526; border-radius: 999px; padding: 6px 10px; border: 1px solid #1f2937; color: #cbd5e1; font-size: 12px; }

    .admin-only { color: #fbbf24; font-weight: 600; font-size: 12px; margin-left: 6px; }
    .preset-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .preset-row .btn { padding: 8px 12px; }
    .preset-form { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 10px; }
    .error { color: #fca5a5; font-size: 13px; margin-top: 6px; }

    /* Landing */
    .landing {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, #c7d2fe 0, rgba(199,210,254,0) 30%),
                  radial-gradient(circle at 80% 0%, #bae6fd 0, rgba(186,230,253,0) 25%),
                  #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
      padding: 20px;
    }

    .landing-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.12);
      padding: 28px;
      max-width: 520px;
      width: 100%;
      border: 1px solid #e2e8f0;
    }

    .landing h1 { margin: 0 0 6px; color: #0f172a; font-size: 24px; }
    .landing p { margin: 0 0 18px; color: #475569; line-height: 1.6; }
    .landing-actions { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .landing input { width: 220px; padding: 10px 12px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .landing .ghost-btn { background: #0ea5e9; color: #fff; border: none; padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 10px 30px rgba(14,165,233,0.25); }
    .landing .ghost-btn.secondary { background: #0f172a; color: #fff; box-shadow: none; }
    .landing .ghost-btn:active { transform: translateY(1px); }

    /* Guest */
    #guest-view { background: #fff; min-height: 100vh; color: #0f172a; }
    .guest-wrap { max-width: 980px; margin: 0 auto; padding: 36px 20px 48px; display: grid; grid-template-columns: 1fr 320px; gap: 16px; }
    .guest-card { border: 1px solid #e2e8f0; border-radius: 16px; padding: 18px; box-shadow: 0 14px 40px rgba(15,23,42,0.05); background: #fff; }
    .guest-card h3 { margin: 0 0 10px; font-size: 18px; color: #0f172a; }
    .guest-upload { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; width: 100%; min-height: 160px; border: 1px dashed #cbd5e1; border-radius: 14px; padding: 24px; text-align: center; color: #475569; background: linear-gradient(180deg, #f8fafc, #fff); cursor: pointer; transition: border-color 0.2s ease, transform 0.1s ease; }
    .guest-upload:hover { border-color: #0ea5e9; transform: translateY(-1px); }
    .guest-upload input { display: none; }
    .guest-options { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 10px; margin-top: 12px; }
    .guest-options label { display: flex; flex-direction: column; gap: 6px; font-weight: 600; color: #1f2937; }
    .guest-options select { padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 12px; background: #fff; color: #0f172a; }
    .guest-btn { width: 100%; margin-top: 16px; padding: 12px 14px; border-radius: 12px; border: none; background: linear-gradient(90deg,#0ea5e9,#38bdf8); color: #fff; font-weight: 700; cursor: pointer; box-shadow: 0 14px 30px rgba(56,189,248,0.25); }
    .guest-btn:active { transform: translateY(1px); }
    .guest-announcement { margin-top: 10px; padding: 12px; border-radius: 12px; background: #f8fafc; border: 1px solid #e2e8f0; color: #334155; line-height: 1.6; white-space: pre-wrap; }
    .guest-result { margin-top: 16px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; padding: 12px; text-align: center; }
    .guest-result img { max-width: 100%; border-radius: 12px; }
    .switch-link { display: inline-flex; align-items: center; gap: 6px; font-weight: 600; color: #0ea5e9; cursor: pointer; text-decoration: none; }
  </style>
</head>
<body>
  <div id="landing" class="landing">
    <div class="landing-card">
      <h1>选择访问模式</h1>
      <p>请输入管理员密钥进入完整控制台，或以访客身份体验精简上传与翻译功能。</p>
      <div class="landing-actions">
        <input id="landing-admin-key" type="password" placeholder="管理员密钥 (WEB_CONSOLE_ADMIN_KEY)" />
        <button id="landing-admin-btn" class="ghost-btn">管理员登录</button>
        <button id="landing-guest-btn" class="ghost-btn secondary">访客访问</button>
      </div>
      <p style="margin-top:12px;color:#64748b;font-size:14px;">可随时在界面右上角切换访问身份。</p>
    </div>
  </div>

  <div id="guest-view" style="display:none;">
    <div class="guest-wrap">
      <div class="guest-card">
        <h3>图片上传</h3>
        <label class="guest-upload" for="guest-file">
          <div id="guest-file-label">点击选择一张图片进行翻译</div>
          <input id="guest-file" type="file" accept="image/*" />
        </label>
        <div class="guest-options">
          <label>目标语言
            <select id="guest-target"></select>
          </label>
          <label>管理员预设
            <select id="guest-preset"></select>
          </label>
          <label>检测器
            <select id="guest-detector"></select>
          </label>
          <label>OCR 模型
            <select id="guest-ocr"></select>
          </label>
        </div>
        <button id="guest-translate-btn" class="guest-btn">开始翻译</button>
        <div id="guest-result" class="guest-result" style="display:none;"></div>
      </div>
      <div class="guest-card">
        <h3>公告栏</h3>
        <div id="guest-announcement" class="guest-announcement"></div>
        <div style="margin-top:12px; font-size:14px; color:#64748b; display:flex; flex-direction:column; gap:6px;">进入管理员模式可编辑公告与完整设置。
          <a id="guest-switch" class="switch-link">切换到管理员模式</a>
        </div>
      </div>
    </div>
  </div>

  <div id="admin-view" style="display:none;">
  <header>
    <div class="title">Manga Translator 云端控制台</div>
    <div class="badge">与本地界面一致的全量设置</div>
    <div class="spacer"></div>
    <button id="switch-mode-btn" class="btn secondary">切换访问身份</button>
    <span id="admin-status" class="pill">访客模式</span>
    <button id="admin-btn" class="btn secondary">管理员登录</button>
    <button id="reset-btn" class="btn secondary">恢复默认设置</button>
    <button id="translate-btn" class="btn">开始翻译</button>
  </header>

  <div class="layout">
    <div class="panel">
      <h3>文件列表</h3>
      <div id="dropzone" class="upload-area">
        拖拽图片到此处，或 <strong>点击选择文件</strong>
        <input id="file-input" type="file" accept="image/*" multiple style="display:none;" />
      </div>
      <ul id="file-list" class="file-list"></ul>
      <div class="toolbar" style="margin-top: 8px;">
        <button id="add-btn" class="btn secondary">添加图片</button>
        <button id="clear-btn" class="btn secondary">清空列表</button>
        <span class="pill" id="queue-info">0 张待处理</span>
      </div>

      <div class="card" style="margin-top: 14px;">
        <h4>翻译结果</h4>
        <p class="hint">每个结果都会自动显示在下方，可点击下载。</p>
        <div id="preview-grid" class="preview-grid"></div>
      </div>
    </div>

    <div class="panel">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="basic">基础设置</button>
        <button class="tab-btn" data-tab="advanced">高级设置</button>
        <button class="tab-btn" data-tab="options">选项</button>
        <button class="tab-btn" data-tab="logs">日志</button>
      </div>

      <div class="tabs-content">
        <div id="tab-basic" class="tab-panel active">
          <div class="grid-two">
            <div class="card">
              <h4>翻译与 CLI</h4>
              <div id="translator-settings"></div>
            </div>
            <div class="card">
              <h4>输出与 CLI 控制</h4>
              <div id="cli-settings"></div>
            </div>
          </div>
          <div class="card" style="margin-top: 12px;">
            <h4>云端 API 预设 <span class="admin-only">管理员可编辑</span></h4>
            <div id="preset-zone"></div>
            <div id="preset-error" class="error" style="display:none;"></div>
          </div>
          <div class="card" style="margin-top: 12px;">
            <h4>公告栏文案 <span class="admin-only">管理员可编辑</span></h4>
            <p class="hint">访客页面将显示此公告。未登录管理员时仅可查看。</p>
            <textarea id="announcement-input" rows="4" placeholder="填写公告内容"></textarea>
            <div class="settings-actions">
              <button id="announcement-save" class="btn secondary">保存公告</button>
            </div>
            <div id="announcement-msg" class="hint"></div>
          </div>
        </div>

        <div id="tab-advanced" class="tab-panel">
          <div class="grid-two">
            <div class="card">
              <h4>检测与修复</h4>
              <div id="detector-settings"></div>
              <div id="inpainter-settings"></div>
            </div>
            <div class="card">
              <h4>渲染 / 超分 / 上色</h4>
              <div id="render-settings"></div>
              <div id="upscale-settings"></div>
              <div id="colorizer-settings"></div>
            </div>
          </div>
        </div>

        <div id="tab-options" class="tab-panel">
          <div class="grid-two">
            <div class="card">
              <h4>OCR 设置</h4>
              <div id="ocr-settings"></div>
            </div>
            <div class="card">
              <h4>全局与其他</h4>
              <div id="global-settings"></div>
            </div>
          </div>
        </div>

        <div id="tab-logs" class="tab-panel">
          <div class="card">
            <h4>执行日志</h4>
            <div id="log-box" class="log-box"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script>
    const DISPLAY_MAP = {
      translator: '翻译器',
      target_lang: '目标语言',
      no_text_lang_skip: '跳过目标语文本',
      skip_lang: '跳过语言',
      gpt_config: 'GPT 配置文件',
      high_quality_prompt_path: '高质量提示词',
      translator_chain: '串联翻译器',
      selective_translation: '选择性翻译',
      attempts: '重试次数',
      max_requests_per_minute: '每分钟请求上限',
      enable_post_translation_check: '译后检查',
      post_check_max_retry_attempts: '译后重试次数',
      post_check_repetition_threshold: '重复阈值',
      post_check_target_lang_threshold: '目标语占比阈值',
      force_strict_layout: '严格布局',
      verbose: '详细日志',
      ignore_errors: '忽略错误',
      use_gpu: '启用 GPU',
      use_gpu_limited: '限制 GPU',
      context_size: '上下文大小',
      format: '导出格式',
      overwrite: '覆盖输出',
      skip_no_text: '跳过无文字',
      save_text: '保存文字',
      load_text: '加载文字',
      template: '导出模版',
      save_quality: '保存质量',
      batch_size: '批大小',
      batch_concurrent: '并行批处理',
      generate_and_export: '生成并导出',
      colorize_only: '仅上色',
      upscale_only: '仅超分',
      detector: '检测器',
      detection_size: '检测尺寸',
      text_threshold: '文字阈值',
      det_rotate: '启用旋转',
      det_auto_rotate: '自动旋转',
      det_invert: '反色检测',
      det_gamma_correct: '伽马矫正',
      use_yolo_obb: 'YOLO OBB 辅助',
      yolo_obb_conf: 'YOLO 置信度',
      yolo_obb_iou: 'YOLO IOU',
      yolo_obb_overlap_threshold: 'YOLO 重叠阈值',
      box_threshold: '文本框阈值',
      unclip_ratio: '膨胀比例',
      min_box_area_ratio: '最小区域比例',
      force_simple_sort: '简易排序',
      inpainter: '修复器',
      inpainting_size: '修复尺寸',
      inpainting_precision: '修复精度',
      inpainting_split_ratio: '分块比例',
      renderer: '渲染器',
      alignment: '对齐方式',
      disable_font_border: '关闭描边',
      disable_auto_wrap: '关闭自动换行',
      font_size_offset: '字号偏移',
      font_size_minimum: '最小字号',
      max_font_size: '最大字号',
      font_scale_ratio: '字号缩放',
      center_text_in_bubble: '气泡居中',
      optimize_line_breaks: '优化换行',
      check_br_and_retry: '检查换行并重试',
      strict_smart_scaling: '严格智能缩放',
      font_size: '固定字号',
      line_spacing: '行间距',
      font_path: '字体路径',
      gimp_font: '字体名',
      auto_rotate_symbols: '符号自动旋转',
      rtl: 'RTL',
      layout_mode: '布局模式',
      font_color: '字体颜色',
      stroke_width: '描边宽度',
      upscaler: '超分模型',
      upscale_ratio: '超分倍数',
      realcugan_model: 'RealCUGAN 模型',
      tile_size: '分块大小',
      revert_upscaling: '还原原尺寸',
      colorization_size: '上色尺寸',
      denoise_sigma: '降噪强度',
      colorizer: '上色器',
      use_mocr_merge: '合并框',
      ocr: 'OCR 模型',
      use_hybrid_ocr: '混合 OCR',
      secondary_ocr: '二级 OCR',
      min_text_length: '最小长度',
      ignore_bubble: '忽略气泡阈值',
      prob: '置信度阈值',
      merge_gamma: '合并 Gamma',
      merge_sigma: '合并 Sigma',
      merge_edge_ratio_threshold: '边缘比阈值',
      filter_text: '文本过滤正则',
      kernel_size: '卷积核大小',
      mask_dilation_offset: '遮罩膨胀',
      last_output_path: '输出目录',
      theme: '主题',
      favorite_folders: '收藏目录'
    };

    const ENUM_OPTIONS = {
      translator: ['youdao','baidu','deepl','papago','caiyun','openai','none','original','sakura','groq','gemini','openai_hq','gemini_hq','offline','nllb','nllb_big','sugoi','jparacrawl','jparacrawl_big','m2m100','m2m100_big','mbart50','qwen2','qwen2_big'],
      target_lang: ['CHS','CHT','JPN','ENG','KOR','ESP','FRA','DEU','ITA','RUS','POL','PTB','ROM','TRK','UKR','VIN','ARA','CNR','SRP','HRV','THA','IND','FIL','NLD','CSY','HUN'],
      detector: ['default','dbconvnext','ctd','craft','none'],
      inpainter: ['default','lama_large','lama_mpe','sd','none','original'],
      inpainting_precision: ['fp32','fp16','bf16'],
      renderer: ['default','manga2eng','manga2eng_pillow','none'],
      alignment: ['auto','left','center','right'],
      direction: ['auto','horizontal','vertical'],
      layout_mode: ['smart_scaling','legacy','simple'],
      upscaler: ['waifu2x','esrgan','4xultrasharp','realcugan'],
      colorizer: ['none','mc2'],
      ocr: ['32px','48px','48px_ctc','mocr','paddleocr','paddleocr_korean','paddleocr_latin'],
      secondary_ocr: ['32px','48px','48px_ctc','mocr','paddleocr','paddleocr_korean','paddleocr_latin'],
      format: ['不指定','json','text','csv'],
      theme: ['light','dark']
    };

    const ANNOUNCEMENT_KEY = 'mt_guest_announcement';
    const DEFAULT_ANNOUNCEMENT = `本项目完全免费。
项目地址：https://github.com/hgmzhn/manga-translator-ui
受限于服务器资源，当前仅支持基础功能体验，完整服务如ai断句、编辑、批量翻译、超分等请于Github下载本项目。`;

    const SECTION_FIELDS = {
      translator: [
        'translator','target_lang','skip_lang','no_text_lang_skip','gpt_config','high_quality_prompt_path','translator_chain','selective_translation','attempts','max_requests_per_minute','enable_post_translation_check','post_check_max_retry_attempts','post_check_repetition_threshold','post_check_target_lang_threshold'
      ],
      cli: [
        'verbose','attempts','ignore_errors','use_gpu','use_gpu_limited','context_size','format','overwrite','skip_no_text','save_text','load_text','template','save_quality','batch_size','batch_concurrent','generate_and_export','colorize_only','upscale_only','last_output_path'
      ],
      detector: [
        'detector','detection_size','text_threshold','det_rotate','det_auto_rotate','det_invert','det_gamma_correct','use_yolo_obb','yolo_obb_conf','yolo_obb_iou','yolo_obb_overlap_threshold','box_threshold','unclip_ratio','min_box_area_ratio'
      ],
      inpainter: [
        'inpainter','inpainting_size','inpainting_precision','inpainting_split_ratio'
      ],
      render: [
        'renderer','force_strict_layout','alignment','direction','disable_font_border','disable_auto_wrap','font_size_offset','font_size_minimum','max_font_size','font_scale_ratio','center_text_in_bubble','optimize_line_breaks','check_br_and_retry','strict_smart_scaling','font_size','line_spacing','font_path','gimp_font','no_hyphenation','font_color','auto_rotate_symbols','rtl','layout_mode','stroke_width'
      ],
      upscale: [
        'upscaler','upscale_ratio','realcugan_model','tile_size','revert_upscaling'
      ],
      colorizer: [
        'colorizer','colorization_size','denoise_sigma'
      ],
      ocr: [
        'use_mocr_merge','ocr','use_hybrid_ocr','secondary_ocr','min_text_length','ignore_bubble','prob','merge_gamma','merge_sigma','merge_edge_ratio_threshold'
      ],
      global: [
        'filter_text','kernel_size','mask_dilation_offset','force_simple_sort'
      ],
    };

    let configData = {};
    let defaultConfig = {};
    let files = [];
    let results = [];
    let adminMode = false;
    let guestFile = null;
    let announcementText = '';
    let adminKey = '';
    let presetCache = [];
    let presetsLoaded = false;
    const PRESET_STORE = 'mt_cloud_api_presets_v2';
    const PRESET_SELECT_STORE = 'mt_cloud_api_selected_v2';
    const ADMIN_KEY_STORE = 'mt_admin_key';
    const ADMIN_CONFIG_STORE = 'mt_admin_config_v1';

    let persistConfigTimer = null;
    const logBox = document.getElementById('log-box');

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logBox.textContent += `[${time}] ${msg}\n`;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function clone(obj) {
      return JSON.parse(JSON.stringify(obj || {}));
    }

    function loadAnnouncement() {
      const saved = localStorage.getItem(ANNOUNCEMENT_KEY);
      return saved && saved.trim() ? saved : DEFAULT_ANNOUNCEMENT;
    }

    function saveAnnouncement(text) {
      announcementText = text;
      localStorage.setItem(ANNOUNCEMENT_KEY, text);
      updateAnnouncementDisplays();
    }

    function updateAnnouncementDisplays() {
      const guestBoard = document.getElementById('guest-announcement');
      const input = document.getElementById('announcement-input');
      if (guestBoard) guestBoard.textContent = announcementText;
      if (input) input.value = announcementText;
    }

    function mergeConfig(base, override) {
      const result = clone(base);
      const apply = (target, source) => {
        Object.entries(source || {}).forEach(([key, value]) => {
          if (value && typeof value === 'object' && !Array.isArray(value)) {
            target[key] = apply(target[key] && typeof target[key] === 'object' ? clone(target[key]) : {}, value);
          } else {
            target[key] = value;
          }
        });
        return target;
      };
      return apply(result, override || {});
    }

    function loadSavedConfig() {
      try {
        const raw = localStorage.getItem(ADMIN_CONFIG_STORE);
        const parsed = raw ? JSON.parse(raw) : null;
        return parsed && typeof parsed === 'object' ? parsed : null;
      } catch {
        return null;
      }
    }

    function cacheConfigLocally(config) {
      try {
        localStorage.setItem(ADMIN_CONFIG_STORE, JSON.stringify(config));
      } catch (e) {
        console.warn('无法保存配置到本地存储', e);
      }
    }

    async function fetchServerConfig() {
      try {
        const res = await fetch('/web/admin-config');
        if (!res.ok) throw new Error('拉取失败');
        const data = await res.json();
        const config = data && typeof data === 'object' ? (data.config || data) : null;
        return config && typeof config === 'object' ? config : null;
      } catch (e) {
        log(`服务器配置拉取失败，尝试本地缓存：${e.message || e}`);
        return null;
      }
    }

    async function persistConfig() {
      cacheConfigLocally(configData);

      if (!adminMode || !adminKey) return;

      try {
        const res = await fetch('/web/admin-config', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Key': adminKey,
          },
          body: JSON.stringify({ config: configData }),
        });

        if (!res.ok) {
          let detail = '保存失败';
          try {
            const raw = await res.text();
            if (raw) {
              const parsed = JSON.parse(raw);
              detail = parsed.detail || parsed.message || detail;
            }
          } catch {}
          throw new Error(detail);
        }
      } catch (e) {
        console.warn('保存到服务器失败，仅本地缓存有效：', e.message || e);
      }
    }

    function getDisplayName(key) {
      return DISPLAY_MAP[key] || key;
    }

    function getOptions(key) {
      return ENUM_OPTIONS[key] || null;
    }

    function isNumber(val) {
      return typeof val === 'number' && !Number.isNaN(val);
    }

    function renderInput(rowEl, sectionKey, key, value) {
      const fullKey = sectionKey ? `${sectionKey}.${key}` : key;
      const options = getOptions(key);

      if (typeof value === 'boolean') {
        const wrapper = document.createElement('label');
        wrapper.className = 'checkbox-row';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = value;
        input.addEventListener('change', () => updateConfigValue(fullKey, input.checked));
        const span = document.createElement('span');
        span.textContent = getDisplayName(key);
        wrapper.appendChild(input);
        wrapper.appendChild(span);
        rowEl.appendChild(wrapper);
        return;
      }

      if (options) {
        const select = document.createElement('select');
        options.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          if (value === opt) option.selected = true;
          select.appendChild(option);
        });
        select.addEventListener('change', () => updateConfigValue(fullKey, select.value));
        rowEl.appendChild(select);
        return;
      }

      const input = document.createElement('input');
      if (isNumber(value)) {
        input.type = 'number';
        input.step = value % 1 === 0 ? '1' : '0.01';
      } else {
        input.type = 'text';
      }
      input.value = value ?? '';
      input.placeholder = '留空为默认';
      input.addEventListener('input', () => {
        let finalVal = input.value;
        if (isNumber(value)) {
          const n = Number(finalVal);
          finalVal = Number.isNaN(n) ? value : n;
        }
        updateConfigValue(fullKey, finalVal === '' ? null : finalVal);
      });
      rowEl.appendChild(input);
    }

    function updateConfigValue(path, value) {
      const segments = path.split('.');
      let cursor = configData;
      for (let i = 0; i < segments.length - 1; i++) {
        const key = segments[i];
        cursor[key] = cursor[key] ?? {};
        cursor = cursor[key];
      }
      cursor[segments[segments.length - 1]] = value;
      schedulePersistConfig();
    }

    function schedulePersistConfig() {
      if (persistConfigTimer) clearTimeout(persistConfigTimer);
      persistConfigTimer = setTimeout(() => { persistConfig(); }, 400);
    }

    function renderSection(containerId, sectionKey, sectionData) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const defaultSection = sectionKey ? (defaultConfig[sectionKey] || {}) : defaultConfig;
      const fields = SECTION_FIELDS[sectionKey || 'global'];
      const entries = (fields && fields.length
        ? fields.map(key => [key, (sectionData && sectionData[key] !== undefined ? sectionData[key] : defaultSection ? defaultSection[key] : null)])
        : Object.entries(sectionData || {}));
      entries.forEach(([key, value]) => {
        const row = document.createElement('div');
        row.className = 'form-row';
        const label = document.createElement('label');
        label.textContent = getDisplayName(key);
        row.appendChild(label);
        renderInput(row, sectionKey, key, value);
        container.appendChild(row);
      });
    }

    function renderAll() {
      renderSection('translator-settings', 'translator', configData.translator || {});
      renderSection('cli-settings', 'cli', configData.cli || {});
      renderSection('detector-settings', 'detector', configData.detector || {});
      renderSection('inpainter-settings', 'inpainter', configData.inpainter || {});
      renderSection('render-settings', 'render', configData.render || {});
      renderSection('upscale-settings', 'upscale', configData.upscale || {});
      renderSection('colorizer-settings', 'colorizer', configData.colorizer || {});
      renderSection('ocr-settings', 'ocr', configData.ocr || {});

      const globals = {};
      SECTION_FIELDS.global.forEach(key => {
        globals[key] = configData[key] ?? defaultConfig[key] ?? null;
      });
      renderSection('global-settings', 'global', globals);
      renderPresetZone();
    }

    async function loadConfig() {
      try {
        const res = await fetch('/web/default-config');
        const data = await res.json();
        defaultConfig = clone(data);
        const serverSaved = await fetchServerConfig();
        const localSaved = loadSavedConfig();
        const saved = serverSaved || localSaved;
        configData = saved ? mergeConfig(defaultConfig, saved) : clone(defaultConfig);
        cacheConfigLocally(configData);
        renderAll();
        renderGuestOptions();
        log(serverSaved ? '已载入服务器保存的配置' : '默认配置已载入');
      } catch (e) {
        log('载入配置失败，请检查服务是否启动');
      }
    }

    function resetConfig() {
      configData = clone(defaultConfig);
      schedulePersistConfig();
      renderAll();
      log('已恢复默认配置');
    }

    function renderFileList() {
      const list = document.getElementById('file-list');
      list.innerHTML = '';
      files.forEach((item, idx) => {
        const li = document.createElement('li');
        li.className = 'file-item';
        const name = document.createElement('div');
        name.className = 'file-name';
        name.textContent = item.file.name;
        const status = document.createElement('div');
        status.className = 'file-status';
        status.textContent = item.status || '待处理';
        const del = document.createElement('button');
        del.className = 'btn secondary';
        del.textContent = '移除';
        del.addEventListener('click', () => {
          files.splice(idx,1);
          renderFileList();
          updateQueueInfo();
        });
        li.appendChild(name);
        li.appendChild(status);
        li.appendChild(del);
        list.appendChild(li);
      });
      updateQueueInfo();
    }

    function updateQueueInfo() {
      const pill = document.getElementById('queue-info');
      pill.textContent = `${files.length} 张待处理`;
    }

    function addFiles(fileList) {
      for (const file of fileList) {
        if (!file.type.startsWith('image/')) continue;
        files.push({ file, status: '待处理' });
      }
      renderFileList();
      log(`已添加 ${fileList.length} 个文件`);
    }

    function populateSelect(el, options, selected) {
      el.innerHTML = '';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        if (opt === selected) option.selected = true;
        el.appendChild(option);
      });
    }

    function renderGuestOptions() {
      const presetSelect = document.getElementById('guest-preset');
      const targetSelect = document.getElementById('guest-target');
      const detectorSelect = document.getElementById('guest-detector');
      const ocrSelect = document.getElementById('guest-ocr');
      if (!presetSelect) return;

      populateSelect(targetSelect, ENUM_OPTIONS.target_lang || [], configData?.translator?.target_lang || 'CHS');
      populateSelect(detectorSelect, ENUM_OPTIONS.detector || [], configData?.detector?.detector || 'default');
      populateSelect(ocrSelect, ENUM_OPTIONS.ocr || [], configData?.ocr?.ocr || 'mocr');

      presetSelect.innerHTML = '';
      const empty = document.createElement('option');
      empty.value = '';
      empty.textContent = '不使用预设';
      presetSelect.appendChild(empty);
      loadPresets().forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        presetSelect.appendChild(opt);
      });
      presetSelect.value = currentPresetName();
    }

    function renderTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
          document.getElementById(`tab-${tab}`).classList.add('active');
        });
      });
    }

    function renderPreview() {
      const grid = document.getElementById('preview-grid');
      grid.innerHTML = '';
      results.forEach(item => {
        const card = document.createElement('div');
        card.className = 'thumb';
        const img = document.createElement('img');
        img.src = item.url;
        img.alt = item.name;
        const caption = document.createElement('div');
        caption.textContent = item.name;
        const link = document.createElement('a');
        link.href = item.url;
        link.download = `${item.name}-translated.png`;
        link.textContent = '下载结果';
        card.appendChild(img);
        card.appendChild(caption);
        card.appendChild(link);
        grid.appendChild(card);
      });
    }

    function readLocalPresets() {
      try {
        const raw = localStorage.getItem(PRESET_STORE);
        const parsed = raw ? JSON.parse(raw) : [];
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function writeLocalPresets(list) {
      localStorage.setItem(PRESET_STORE, JSON.stringify(list));
    }

    function loadPresets() {
      if (!presetsLoaded) {
        presetCache = readLocalPresets();
        presetsLoaded = true;
      }
      return presetCache;
    }

    function setCachedPresets(list) {
      presetCache = Array.isArray(list) ? list : [];
      presetsLoaded = true;
      writeLocalPresets(presetCache);
    }

    async function refreshPresetsFromServer() {
      try {
        const res = await fetch('/web/api-presets');
        if (!res.ok) throw new Error('拉取失败');
        const data = await res.json();
        if (Array.isArray(data)) {
          setCachedPresets(data);
          return data;
        }
      } catch (e) {
        log(`云端预设拉取失败，继续使用本地数据：${e.message || e}`);
      }
      return loadPresets();
    }

    async function persistPresets(list) {
      if (!adminKey) throw new Error('请先登录管理员');
      const res = await fetch('/web/api-presets', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Key': adminKey,
        },
        body: JSON.stringify({ presets: list }),
      });
      if (!res.ok) {
        let detail = '保存失败';
        try {
          const raw = await res.text();
          if (raw) {
            try {
              const data = JSON.parse(raw);
              detail = data.detail || data.message || detail;
            } catch {
              detail = `${detail}: ${raw}`;
            }
          }
        } catch (e) {
          detail = `${detail}: ${e.message || e}`;
        }
        throw new Error(detail);
      }
      setCachedPresets(list);
    }

    function currentPresetName() {
      return localStorage.getItem(PRESET_SELECT_STORE) || '';
    }

    function setCurrentPreset(name) {
      localStorage.setItem(PRESET_SELECT_STORE, name || '');
    }

    function getSelectedPreset() {
      const name = currentPresetName();
      return loadPresets().find(p => p.name === name) || null;
    }

    function renderPresetZone() {
      const container = document.getElementById('preset-zone');
      let presets = loadPresets();
      const selected = currentPresetName();
      container.innerHTML = '';

      const row = document.createElement('div');
      row.className = 'preset-row';

      const select = document.createElement('select');
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = '不使用预设';
      select.appendChild(emptyOption);
      presets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        if (p.name === selected) opt.selected = true;
        select.appendChild(opt);
      });
      select.addEventListener('change', () => {
        setCurrentPreset(select.value);
        renderPresetZone();
      });
      row.appendChild(select);

      const info = document.createElement('span');
      info.className = 'hint';
      info.textContent = adminMode ? '已登录管理员，可编辑云端 API 预设' : '访客只能选择预设名称，管理员可编辑详情';
      row.appendChild(info);
      container.appendChild(row);

      if (adminMode) {
        const form = document.createElement('div');
        form.className = 'preset-form';

        const fields = [
          { key: 'name', label: '预设名称', type: 'text' },
          { key: 'api_base', label: 'Base URL', type: 'text' },
          { key: 'api_model', label: '模型名称', type: 'text' },
          { key: 'api_key', label: 'API Key', type: 'password' },
        ];

        const editing = presets.find(p => p.name === selected) || { name: '', api_base: '', api_model: '', api_key: '' };
        const inputs = {};

        fields.forEach(f => {
          const wrap = document.createElement('div');
          wrap.className = 'form-row';
          const label = document.createElement('label');
          label.textContent = f.label;
          const input = document.createElement('input');
          input.type = f.type;
          input.value = editing[f.key] || '';
          inputs[f.key] = input;
          wrap.appendChild(label);
          wrap.appendChild(input);
          form.appendChild(wrap);
        });

        const actions = document.createElement('div');
        actions.className = 'preset-row';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn secondary';
        saveBtn.textContent = '保存 / 更新预设';
        saveBtn.addEventListener('click', async () => {
          const name = inputs.name.value.trim();
          if (!name) {
            showPresetError('请填写预设名称');
            return;
          }
          hidePresetError();
          const updated = presets.filter(p => p.name !== name);
          updated.push({
            name,
            api_base: inputs.api_base.value.trim(),
            api_model: inputs.api_model.value.trim(),
            api_key: inputs.api_key.value.trim(),
          });
          try {
            await persistPresets(updated);
            presets = loadPresets();
            setCurrentPreset(name);
            renderPresetZone();
            log(`已保存预设 ${name}`);
          } catch (e) {
            showPresetError(e.message || '保存失败');
          }
        });

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn secondary';
        deleteBtn.textContent = '删除预设';
        deleteBtn.addEventListener('click', async () => {
          if (!selected) return;
          const filtered = presets.filter(p => p.name !== selected);
          try {
            await persistPresets(filtered);
            presets = loadPresets();
            setCurrentPreset('');
            renderPresetZone();
            log(`已删除预设 ${selected}`);
          } catch (e) {
            showPresetError(e.message || '删除失败');
          }
        });

        actions.appendChild(saveBtn);
        actions.appendChild(deleteBtn);
        form.appendChild(actions);
        container.appendChild(form);
      }

      renderGuestOptions();
    }

    function showPresetError(msg) {
      const el = document.getElementById('preset-error');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hidePresetError() {
      const el = document.getElementById('preset-error');
      el.style.display = 'none';
    }

    async function translateQueue() {
      if (!files.length) {
        log('请先添加图片');
        return;
      }
      document.getElementById('translate-btn').disabled = true;
      for (const item of files) {
        item.status = '翻译中…';
        renderFileList();
        try {
          const blobUrl = await translateSingle(item.file);
          results.push({ name: item.file.name, url: blobUrl });
          item.status = '完成';
          renderPreview();
          log(`${item.file.name} 翻译完成`);
        } catch (e) {
          item.status = '失败';
          log(`${item.file.name} 翻译失败: ${e.message || e}`);
        }
        renderFileList();
      }
      document.getElementById('translate-btn').disabled = false;
    }

    async function translateSingle(file) {
      const preset = getSelectedPreset();
      const fd = new FormData();
      fd.append('image', file);
      fd.append('config', JSON.stringify(configData));
      if (preset) {
        if (preset.api_base) fd.append('api_base', preset.api_base);
        if (preset.api_key) fd.append('api_key', preset.api_key);
        if (preset.api_model) fd.append('api_model', preset.api_model);
      }
      const res = await fetch('/translate/with-form/image', {
        method: 'POST',
        body: fd,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || '翻译失败');
      }
      const blob = await res.blob();
      return URL.createObjectURL(blob);
    }

    async function translateGuestSingle(file) {
      const presetName = document.getElementById('guest-preset').value;
      const preset = loadPresets().find(p => p.name === presetName) || null;
      const fd = new FormData();
      fd.append('image', file);
      const guestConfig = clone(configData);
      guestConfig.translator = guestConfig.translator || {};
      guestConfig.detector = guestConfig.detector || {};
      guestConfig.ocr = guestConfig.ocr || {};
      guestConfig.translator.target_lang = document.getElementById('guest-target').value;
      guestConfig.detector.detector = document.getElementById('guest-detector').value;
      guestConfig.ocr.ocr = document.getElementById('guest-ocr').value;
      fd.append('config', JSON.stringify(guestConfig));
      if (preset) {
        if (preset.api_base) fd.append('api_base', preset.api_base);
        if (preset.api_key) fd.append('api_key', preset.api_key);
        if (preset.api_model) fd.append('api_model', preset.api_model);
      }
      const res = await fetch('/translate/with-form/image', {
        method: 'POST',
        body: fd,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || '翻译失败');
      }
      const blob = await res.blob();
      return URL.createObjectURL(blob);
    }

    function showLanding() {
      document.getElementById('landing').style.display = 'flex';
      document.getElementById('guest-view').style.display = 'none';
      document.getElementById('admin-view').style.display = 'none';
    }

    function enterGuestMode() {
      adminMode = false;
      sessionStorage.removeItem('mt_admin');
      updateAdminStatus();
      renderPresetZone();
      syncAnnouncementEditor();
      updateAnnouncementDisplays();
      guestFile = null;
      const guestInput = document.getElementById('guest-file');
      if (guestInput) guestInput.value = '';
      const guestLabel = document.getElementById('guest-file-label');
      if (guestLabel) guestLabel.textContent = '点击选择一张图片进行翻译';
      document.getElementById('guest-result').style.display = 'none';
      document.getElementById('landing').style.display = 'none';
      document.getElementById('guest-view').style.display = 'block';
      document.getElementById('admin-view').style.display = 'none';
    }

    function enterAdminMode() {
      document.getElementById('landing').style.display = 'none';
      document.getElementById('guest-view').style.display = 'none';
      document.getElementById('admin-view').style.display = 'block';
      syncAnnouncementEditor();
      updateAnnouncementDisplays();
    }

    function syncAnnouncementEditor() {
      const input = document.getElementById('announcement-input');
      const btn = document.getElementById('announcement-save');
      const msg = document.getElementById('announcement-msg');
      if (!input || !btn || !msg) return;
      input.value = announcementText;
      input.disabled = !adminMode;
      btn.disabled = !adminMode;
      msg.textContent = adminMode ? '' : '登录管理员后可编辑公告';
    }

    async function translateGuest() {
      if (!guestFile) {
        setGuestResult('<div style="color:#dc2626;">请先选择一张图片</div>');
        return;
      }
      const btn = document.getElementById('guest-translate-btn');
      btn.disabled = true;
      btn.textContent = '翻译中…';
      try {
        const url = await translateGuestSingle(guestFile);
        setGuestResult(`<img src="${url}" alt="翻译结果" />`);
      } catch (e) {
        setGuestResult(`<div style="color:#dc2626;">${e.message || e}</div>`);
      } finally {
        btn.disabled = false;
        btn.textContent = '开始翻译';
      }
    }

    function setGuestResult(html) {
      const box = document.getElementById('guest-result');
      box.style.display = 'block';
      box.innerHTML = html;
    }

    async function promptAdminLogin(providedKey) {
      const key = typeof providedKey === 'string' ? providedKey : prompt('请输入管理员密钥 (WEB_CONSOLE_ADMIN_KEY)');
      if (!key) return false;
      try {
        const res = await fetch('/web/admin-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });
        if (!res.ok) throw new Error((await res.json()).detail || '认证失败');
        adminMode = true;
        adminKey = key;
        sessionStorage.setItem('mt_admin', '1');
        sessionStorage.setItem(ADMIN_KEY_STORE, key);
        updateAdminStatus();
        await refreshPresetsFromServer();
        renderPresetZone();
        syncAnnouncementEditor();
        enterAdminMode();
        updateAnnouncementDisplays();
        log('管理员登录成功');
        return true;
      } catch (e) {
        log(`管理员登录失败：${e.message}`);
        alert('管理员密钥错误或未配置');
        return false;
      }
    }

    function logoutAdmin() {
      adminMode = false;
      adminKey = '';
      sessionStorage.removeItem('mt_admin');
      sessionStorage.removeItem(ADMIN_KEY_STORE);
      updateAdminStatus();
      renderPresetZone();
      syncAnnouncementEditor();
      showLanding();
    }

    function updateAdminStatus() {
      const badge = document.getElementById('admin-status');
      const btn = document.getElementById('admin-btn');
      if (adminMode) {
        badge.textContent = '管理员';
        badge.style.background = '#12263f';
        btn.textContent = '退出登录';
      } else {
        badge.textContent = '访客模式';
        badge.style.background = '#0d1526';
        btn.textContent = '管理员登录';
      }
    }

    function restoreAdminSession() {
      adminMode = sessionStorage.getItem('mt_admin') === '1';
      adminKey = sessionStorage.getItem(ADMIN_KEY_STORE) || '';
      updateAdminStatus();
    }

    document.addEventListener('DOMContentLoaded', () => {
      announcementText = loadAnnouncement();
      updateAnnouncementDisplays();
      renderTabs();
      restoreAdminSession();
      loadPresets();
      refreshPresetsFromServer().then(() => { renderPresetZone(); renderGuestOptions(); });
      loadConfig();

      document.getElementById('landing-admin-btn').addEventListener('click', async () => {
        const key = document.getElementById('landing-admin-key').value.trim();
        await promptAdminLogin(key);
      });
      document.getElementById('landing-guest-btn').addEventListener('click', enterGuestMode);
      document.getElementById('switch-mode-btn').addEventListener('click', showLanding);
      document.getElementById('guest-switch').addEventListener('click', showLanding);

      document.getElementById('dropzone').addEventListener('click', () => document.getElementById('file-input').click());
      document.getElementById('file-input').addEventListener('change', (e) => addFiles(e.target.files));
      document.getElementById('add-btn').addEventListener('click', () => document.getElementById('file-input').click());
      document.getElementById('clear-btn').addEventListener('click', () => { files = []; renderFileList(); results = []; renderPreview(); });
      document.getElementById('reset-btn').addEventListener('click', resetConfig);
      document.getElementById('translate-btn').addEventListener('click', translateQueue);
      document.getElementById('admin-btn').addEventListener('click', () => {
        if (adminMode) {
          logoutAdmin();
        } else {
          promptAdminLogin();
        }
      });

      document.getElementById('guest-file').addEventListener('change', (e) => {
        const [file] = e.target.files || [];
        guestFile = file || null;
        document.getElementById('guest-file-label').textContent = guestFile ? `已选择：${guestFile.name}` : '点击选择一张图片进行翻译';
        document.getElementById('guest-result').style.display = 'none';
      });
      document.getElementById('guest-preset').addEventListener('change', (e) => setCurrentPreset(e.target.value));
      document.getElementById('guest-translate-btn').addEventListener('click', translateGuest);

      document.getElementById('announcement-save').addEventListener('click', () => {
        if (!adminMode) {
          alert('请先登录管理员再编辑公告');
          return;
        }
        const text = document.getElementById('announcement-input').value.trim() || DEFAULT_ANNOUNCEMENT;
        saveAnnouncement(text);
        document.getElementById('announcement-msg').textContent = '公告已保存';
      });

      const dropzone = document.getElementById('dropzone');
      ['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.style.borderColor = '#38bdf8'; }));
      ['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.style.borderColor = '#2b3a52'; }));
      dropzone.addEventListener('drop', (e) => { e.preventDefault(); addFiles(e.dataTransfer.files); });

      renderPresetZone();
      renderFileList();
      renderPreview();

      if (adminMode) {
        enterAdminMode();
      } else {
        showLanding();
      }
      syncAnnouncementEditor();
    });
  </script>
</body>
</html>
