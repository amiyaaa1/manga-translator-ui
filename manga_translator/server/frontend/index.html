<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manga Translator Web 控制台</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0b1622;
      --panel: #111c2a;
      --primary: #4f46e5;
      --text: #e5e7eb;
      --border: #243447;
      --muted: #9ca3af;
    }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 32px 16px;
      box-sizing: border-box;
    }
    .container {
      width: min(1200px, 100%);
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 20px;
      align-items: start;
    }
    @media (max-width: 960px) {
      .container { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 18px 22px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.25);
    }
    h1 { margin: 0 0 10px; font-size: 24px; letter-spacing: 0.2px; }
    p { margin: 0 0 12px; color: var(--muted); }
    label { display: block; font-weight: 600; margin: 12px 0 6px; }
    input[type="file"], textarea, button, select, input[type="text"], input[type="password"] {
      width: 100%;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b1622;
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
    }
    textarea { min-height: 240px; resize: vertical; font-family: "JetBrains Mono", "SFMono-Regular", ui-monospace; }
    button {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.2px;
      box-shadow: 0 10px 30px rgba(99,102,241,0.35);
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 14px 36px rgba(99,102,241,0.45); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .actions { display: flex; gap: 12px; margin-top: 14px; flex-wrap: wrap; }
    .pill {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      color: var(--muted);
    }
    .preview-box { background: #0b1622; border: 1px dashed var(--border); border-radius: 12px; padding: 12px; min-height: 320px; display: flex; align-items: center; justify-content: center; }
    .preview-box img { max-width: 100%; border-radius: 12px; }
    .status {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(79,70,229,0.14);
      color: #c7d2fe;
      border: 1px solid rgba(99,102,241,0.35);
      font-size: 14px;
      white-space: pre-wrap;
    }
    .small { font-size: 13px; color: var(--muted); }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
    .muted { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .inline { display: inline-flex; gap: 10px; align-items: center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Web 控制台</h1>
      <p>上传漫画图片并在云端翻译，内置云端 API 设置（OpenAI 兼容）。</p>

      <label for="imageInput">选择图片</label>
      <input id="imageInput" type="file" accept="image/*" />

      <div class="actions" style="justify-content: space-between; align-items: center;">
        <div class="inline">
          <button id="translateBtn">开始翻译</button>
          <button id="loadDefault">重置默认配置</button>
        </div>
        <button id="adminBtn" style="width:auto;min-width:140px;">管理员登录</button>
      </div>
      <div class="pill">提示：云端 API 设置仅管理员可见可改；非管理员只能看到正在使用的预设名称。</div>

      <h3 style="margin:18px 0 8px;">云端 API 设置（OpenAI 兼容）</h3>
      <div class="muted" id="presetInfo">正在加载预设...</div>
      <div id="adminSection" style="display:none; margin-top:10px;">
        <div class="grid-2">
          <div>
            <label for="presetName">预设名称</label>
            <input id="presetName" type="text" placeholder="如：官方 / 第三方 / 本地反代" />
          </div>
          <div>
            <label for="presetSelect">已保存预设</label>
            <select id="presetSelect"></select>
          </div>
        </div>
        <label for="apiBase">Base URL</label>
        <input id="apiBase" type="text" placeholder="https://api.openai.com/v1" />
        <label for="apiModel">模型名称</label>
        <input id="apiModel" type="text" placeholder="gpt-4o / gpt-4o-mini / qwen-omni" />
        <label for="apiKey">API Key</label>
        <input id="apiKey" type="password" placeholder="sk-..." />
        <div class="actions">
          <button id="savePreset">保存/更新预设</button>
          <button id="forgetAdmin">退出管理员</button>
        </div>
      </div>
      <div id="readonlySection" class="muted" style="display:none;">当前使用预设：<span id="readonlyPreset">-</span></div>
      <div class="pill">兼容 OpenAI / DeepSeek / 其他 OpenAI 格式 API，可自定义 Base URL 与密钥并保存多个预设。</div>
      <div class="pill">提示：若云端禁用了 ctranslate2，offline / m2m100 / sugoi 等离线翻译器会被自动跳过，请改用 nllb / qwen2 / 云端 API。</div>
      <div id="status" class="status" style="display:none"></div>
    </div>

    <div class="card">
      <h2 style="margin-top:0">结果预览</h2>
      <div id="preview" class="preview-box">等待翻译...</div>
      <div class="actions">
        <button id="downloadBtn" disabled>下载结果</button>
      </div>
      <div class="small">接口：POST /translate/with-form/image · 可在 /docs 查看所有参数</div>
    </div>
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const translateBtn = document.getElementById('translateBtn');
    const loadDefaultBtn = document.getElementById('loadDefault');
    const statusEl = document.getElementById('status');
    const previewEl = document.getElementById('preview');
    const downloadBtn = document.getElementById('downloadBtn');
    const adminBtn = document.getElementById('adminBtn');
    const adminSection = document.getElementById('adminSection');
    const presetSelect = document.getElementById('presetSelect');
    const presetName = document.getElementById('presetName');
    const apiBase = document.getElementById('apiBase');
    const apiModel = document.getElementById('apiModel');
    const apiKey = document.getElementById('apiKey');
    const savePresetBtn = document.getElementById('savePreset');
    const presetInfo = document.getElementById('presetInfo');
    const readonlySection = document.getElementById('readonlySection');
    const readonlyPreset = document.getElementById('readonlyPreset');
    const forgetAdminBtn = document.getElementById('forgetAdmin');
    const PRESET_STORAGE_KEY = 'mt_api_presets';
    const ADMIN_FLAG_KEY = 'mt_console_admin';
    let lastBlobUrl = null;
    let defaultConfig = null;
    let adminMode = false;

    function setStatus(text, isError = false) {
      statusEl.style.display = 'block';
      statusEl.style.background = isError ? 'rgba(248,113,113,0.12)' : 'rgba(79,70,229,0.14)';
      statusEl.style.borderColor = isError ? 'rgba(248,113,113,0.4)' : 'rgba(99,102,241,0.35)';
      statusEl.style.color = isError ? '#fecdd3' : '#c7d2fe';
      statusEl.textContent = text;
    }

    function normalizePresets(raw) {
      return (raw || []).map(p => ({
        name: p.name || '未命名预设',
        baseUrl: p.baseUrl || 'https://api.openai.com/v1',
        apiKey: p.apiKey || '',
        model: p.model || 'gpt-4o',
      }));
    }

    function loadPresets() {
      const stored = localStorage.getItem(PRESET_STORAGE_KEY);
      if (stored) {
        try {
          const parsed = JSON.parse(stored);
          const normalized = normalizePresets(parsed);
          savePresets(normalized);
          return normalized;
        } catch (_) {}
      }
      const fallback = normalizePresets([{ name: '默认 OpenAI', baseUrl: 'https://api.openai.com/v1', apiKey: '', model: 'gpt-4o' }]);
      localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(fallback));
      return fallback;
    }

    function savePresets(list) {
      localStorage.setItem(PRESET_STORAGE_KEY, JSON.stringify(list));
    }

    function currentPreset() {
      const presets = loadPresets();
      const selectedName = presetSelect.value || presets[0]?.name;
      return presets.find(p => p.name === selectedName) || presets[0];
    }

    function renderPresets() {
      const presets = loadPresets();
      presetSelect.innerHTML = '';
      presets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        presetSelect.appendChild(opt);
      });
      const active = presets[0];
      if (active) {
        presetSelect.value = active.name;
        presetName.value = active.name;
        apiBase.value = active.baseUrl;
        apiKey.value = active.apiKey || '';
        apiModel.value = active.model || 'gpt-4o';
        readonlyPreset.textContent = active.name;
      }
      presetInfo.textContent = `已保存 ${presets.length} 个预设，需管理员登录才能编辑。`;
    }

    function setAdminMode(on) {
      adminMode = on;
      if (on) {
        sessionStorage.setItem(ADMIN_FLAG_KEY, '1');
        adminSection.style.display = 'block';
        readonlySection.style.display = 'none';
        adminBtn.textContent = '管理员已登录';
      } else {
        sessionStorage.removeItem(ADMIN_FLAG_KEY);
        adminSection.style.display = 'none';
        readonlySection.style.display = 'block';
        adminBtn.textContent = '管理员登录';
      }
    }

    function syncActivePreset() {
      const active = currentPreset();
      if (!active) return;
      presetName.value = active.name;
      apiBase.value = active.baseUrl;
      apiKey.value = active.apiKey || '';
      readonlyPreset.textContent = active.name;
      apiModel.value = active.model || 'gpt-4o';
    }

    async function loadDefault() {
      try {
        setStatus('正在加载示例配置...');
        const res = await fetch('/web/default-config');
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        defaultConfig = data;
        setStatus('示例配置已载入，将自动套用到云端 API 翻译。');
      } catch (err) {
        setStatus(`加载配置失败：${err}`, true);
      }
    }

    async function translate() {
      if (!imageInput.files.length) {
        setStatus('请先选择一张图片。', true);
        return;
      }
      translateBtn.disabled = true;
      loadDefaultBtn.disabled = true;
      setStatus('正在上传并翻译，请稍候...');
      previewEl.textContent = '处理中...';
      downloadBtn.disabled = true;
      if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);

      try {
        const form = new FormData();
        form.append('image', imageInput.files[0]);

        const preset = currentPreset();
        const conf = defaultConfig ? JSON.parse(JSON.stringify(defaultConfig)) : {};
        conf.translator = conf.translator || {};
        conf.translator.translator = 'openai';
        conf.translator.gpt_config = conf.translator.gpt_config || 'examples/gpt_config-example.yaml';
        conf.translator.target_lang = conf.translator.target_lang || 'CHS';
        conf.translator.high_quality_prompt_path = conf.translator.high_quality_prompt_path || 'dict/prompt_example.json';
        form.append('config', JSON.stringify(conf));
        form.append('api_base', preset?.baseUrl || '');
        form.append('api_key', preset?.apiKey || '');
        form.append('api_model', preset?.model || '');

        const res = await fetch('/translate/with-form/image', { method: 'POST', body: form });
        if (!res.ok) {
          const message = await res.text();
          throw new Error(message || `HTTP ${res.status}`);
        }
        const blob = await res.blob();
        lastBlobUrl = URL.createObjectURL(blob);
        const img = new Image();
        img.src = lastBlobUrl;
        img.onload = () => URL.revokeObjectURL(img.src);
        previewEl.innerHTML = '';
        previewEl.appendChild(img);
        downloadBtn.disabled = false;
        setStatus('翻译完成，如需下载请点击下方按钮。');
        downloadBtn.onclick = () => {
          const link = document.createElement('a');
          link.href = lastBlobUrl;
          link.download = 'translated.png';
          link.click();
        };
      } catch (err) {
        setStatus(`翻译失败：${err.message || err}`, true);
        previewEl.textContent = '处理失败，请检查配置或更换翻译器。';
      } finally {
        translateBtn.disabled = false;
        loadDefaultBtn.disabled = false;
      }
    }

    presetSelect?.addEventListener('change', syncActivePreset);
    savePresetBtn?.addEventListener('click', () => {
      const name = presetName.value.trim() || '未命名预设';
      const baseUrl = apiBase.value.trim() || 'https://api.openai.com/v1';
      const model = apiModel.value.trim() || 'gpt-4o';
      const key = apiKey.value.trim();
      const presets = loadPresets();
      const existing = presets.find(p => p.name === name);
      if (existing) {
        existing.baseUrl = baseUrl;
        existing.apiKey = key;
        existing.model = model;
      } else {
        presets.unshift({ name, baseUrl, apiKey: key, model });
      }
      savePresets(presets);
      renderPresets();
      presetSelect.value = name;
      syncActivePreset();
      setStatus(`预设 ${name} 已保存。`);
    });

    adminBtn.addEventListener('click', async () => {
      if (adminMode) return;
      const pwd = prompt('请输入管理员密钥（由部署者在环境变量中设置）：');
      if (!pwd) {
        setStatus('未输入密钥，保持访客模式。');
        return;
      }
      try {
        const res = await fetch('/web/admin-login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: pwd.trim() }),
        });
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg || `HTTP ${res.status}`);
        }
        setAdminMode(true);
        syncActivePreset();
        setStatus('管理员模式已开启，可编辑云端 API 预设。');
      } catch (err) {
        setStatus(`管理员校验失败：${err.message || err}`, true);
      }
    });

    forgetAdminBtn?.addEventListener('click', () => {
      setAdminMode(false);
      setStatus('已退出管理员，云端 API 设置仅显示预设名称。');
    });

    loadDefaultBtn.addEventListener('click', loadDefault);
    translateBtn.addEventListener('click', translate);

    renderPresets();
    setAdminMode(!!sessionStorage.getItem(ADMIN_FLAG_KEY));
    syncActivePreset();
    loadDefault();
  </script>
</body>
</html>
